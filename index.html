<!DOCTYPE html>
<html>
<head>
    <title>Cycle Map</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map {
            height: 100vh; /* Full-screen map */
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        // Initialize the map
        const map = L.map('map').setView([60.7212, -135.0568], 13); // Centered on Whitehorse, adjust as needed

        // Add OpenStreetMap basemap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Function to load GeoJSON
		function loadGeoJSON(url, sheetData) {
			fetch(url)
				.then(response => response.json())
				.then(data => {
					// Debug: Log the full GeoJSON data
					console.log('Loaded GeoJSON:', data);

					// Validate GeoJSON structure
					if (!data || !data.features || !Array.isArray(data.features)) {
						console.error('Invalid GeoJSON structure:', data);
						throw new Error('Invalid GeoJSON structure');
					}

					// Process each feature in the GeoJSON
					data.features.forEach(feature => {
						if (!feature.properties || !feature.properties.Name) {
							console.warn('Feature missing "Name" property:', feature);
							return; // Skip this feature
						}

						const trailName = feature.properties.Name;
						console.log('Processing feature:', trailName); // Debug: Log the trail name

						// Find matching row in the sheet data
						const match = sheetData.find(row => row.Trail === trailName);
						if (match) {
							console.log('Match found for trail:', trailName, match); // Debug: Log the matching row
							feature.properties.condition = match.Condition;
							feature.properties.comments = match.Comments;
						} else {
							console.warn(`No match found for trail: ${trailName}`); // Debug: Warn about unmatched trails
						}
					});

					// Add the GeoJSON layer to the map
					L.geoJSON(data, {
						style: function(feature) {
							const condition = feature.properties.condition;
							return {
								color: condition == 5 ? "green" :
									   condition == 3 ? "yellow" :
									   condition == 2 ? "red" : "gray",
								weight: 4
							};
						},
						onEachFeature: function(feature, layer) {
							const popupContent = `
								<strong>${feature.properties.Name}</strong><br>
								Condition: ${feature.properties.condition || 'Unknown'}<br>
								Comments: ${feature.properties.comments || 'None'}
							`;
							layer.bindPopup(popupContent);
						}
					}).addTo(map);
				})
				.catch(error => console.error('Error loading GeoJSON:', error));
		}



        // Load the Google Sheet and process it
        function loadGoogleSheet() {
            const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRdbtilDhAQM77HRjymspR257EwZJ1U0i42JYVASWjhwk0WkPfTbnY0qOfkOSJ1ZqMUZVefQwmvIjpG/pub?output=csv';
            fetch(sheetURL)
                .then(response => response.text())
                .then(csv => {
                    // Parse the CSV into JSON
                    const sheetData = Papa.parse(csv, { header: true }).data;

                    // Load GeoJSON files and join them with sheet data
                    loadGeoJSON('ChilkootWay.geojson', sheetData);
                    loadGeoJSON('LowerEscarpment.geojson', sheetData);
                    loadGeoJSON('Riverfront.geojson', sheetData);
                })
                .catch(error => console.error('Error loading Google Sheet:', error));
        }

        // Load the sheet and initialize the map
        loadGoogleSheet();
    </script>
</body>
</html>
